import React, { useState, useEffect, useMemo } from 'react';
import { 
  Plus, Minus, PieChart as PieChartIcon, BarChart3, Settings as SettingsIcon, 
  LayoutDashboard, Wallet, ArrowUpCircle, ArrowDownCircle, TrendingUp, 
  AlertCircle, Trash2, Moon, Sun, X, ChevronRight, Lightbulb
} from 'lucide-react';
import { motion, AnimatePresence } from 'motion/react';
import { Chart as ChartJS, ArcElement, Tooltip, Legend, CategoryScale, LinearScale, BarElement, Title } from 'chart.js';
import { Pie, Bar } from 'react-chartjs-2';

ChartJS.register(ArcElement, Tooltip, Legend, CategoryScale, LinearScale, BarElement, Title);

type TransactionType = 'thu' | 'chi';
interface Transaction { id: string; date: string; type: TransactionType; category: string; amount: number; note: string; }
interface Budget { category: string; limit: number; }

const DEFAULT_CATEGORIES = ['ƒÇn u·ªëng', 'Di chuy·ªÉn', 'Mua s·∫Øm', 'H√≥a ƒë∆°n', 'Gi·∫£i tr√≠', 'ƒê·∫ßu t∆∞', 'Ti·∫øt ki·ªám', 'Kh√°c'];
const CATEGORY_COLORS: Record<string, string> = { 'ƒÇn u·ªëng': '#F87171', 'Di chuy·ªÉn': '#FB923C', 'Mua s·∫Øm': '#FBBF24', 'H√≥a ƒë∆°n': '#34D399', 'Gi·∫£i tr√≠': '#60A5FA', 'ƒê·∫ßu t∆∞': '#818CF8', 'Ti·∫øt ki·ªám': '#A78BFA', 'Kh√°c': '#94A3B8' };

export default function App() {
  const [transactions, setTransactions] = useState<Transaction[]>([]);
  const [budgets, setBudgets] = useState<Budget[]>([]);
  const [isDarkMode, setIsDarkMode] = useState(false);
  const [activeTab, setActiveTab] = useState<'dashboard' | 'transactions' | 'reports' | 'settings'>('dashboard');
  const [showAddModal, setShowAddModal] = useState(false);

  useEffect(() => {
    const savedTransactions = localStorage.getItem('chau_money_transactions');
    const savedBudgets = localStorage.getItem('chau_money_budgets');
    const savedTheme = localStorage.getItem('chau_money_theme');
    if (savedTransactions) setTransactions(JSON.parse(savedTransactions));
    if (savedBudgets) setBudgets(JSON.parse(savedBudgets));
    if (savedTheme === 'dark') setIsDarkMode(true);
  }, []);

  useEffect(() => { localStorage.setItem('chau_money_transactions', JSON.stringify(transactions)); }, [transactions]);
  useEffect(() => { localStorage.setItem('chau_money_budgets', JSON.stringify(budgets)); }, [budgets]);
  useEffect(() => {
    localStorage.setItem('chau_money_theme', isDarkMode ? 'dark' : 'light');
    document.documentElement.classList.toggle('dark', isDarkMode);
  }, [isDarkMode]);

  const currentMonth = new Date().getMonth();
  const currentYear = new Date().getFullYear();
  const monthlyTransactions = useMemo(() => transactions.filter(t => { const d = new Date(t.date); return d.getMonth() === currentMonth && d.getFullYear() === currentYear; }), [transactions, currentMonth, currentYear]);
  const totalIncome = useMemo(() => monthlyTransactions.filter(t => t.type === 'thu').reduce((acc, t) => acc + t.amount, 0), [monthlyTransactions]);
  const totalExpense = useMemo(() => monthlyTransactions.filter(t => t.type === 'chi').reduce((acc, t) => acc + t.amount, 0), [monthlyTransactions]);
  const balance = useMemo(() => transactions.reduce((acc, t) => t.type === 'thu' ? acc + t.amount : acc - t.amount, 0), [transactions]);
  const totalBudget = useMemo(() => budgets.reduce((acc, b) => acc + b.limit, 0), [budgets]);
  const budgetProgress = totalBudget > 0 ? (totalExpense / totalBudget) * 100 : 0;

  const aiInsights = useMemo(() => {
    const today = new Date();
    const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
    const dayOfMonth = today.getDate();
    const daysLeft = daysInMonth - dayOfMonth;
    const pastTransactions = transactions.filter(t => { const d = new Date(t.date); return d.getMonth() !== currentMonth || d.getFullYear() !== currentYear; });
    const monthlyData: Record<string, { income: number, expense: number }> = {};
    pastTransactions.forEach(t => { const d = new Date(t.date); const key = `${d.getMonth()}-${d.getFullYear()}`; if (!monthlyData[key]) monthlyData[key] = { income: 0, expense: 0 }; if (t.type === 'thu') monthlyData[key].income += t.amount; else monthlyData[key].expense += t.amount; });
    const pastMonthsCount = Object.keys(monthlyData).length;
    const histAvgIncome = pastMonthsCount > 0 ? Object.values(monthlyData).reduce((acc, m) => acc + m.income, 0) / pastMonthsCount : totalIncome;
    const histAvgExpense = pastMonthsCount > 0 ? Object.values(monthlyData).reduce((acc, m) => acc + m.expense, 0) / pastMonthsCount : totalExpense;
    const currentWeight = Math.min(dayOfMonth / 20, 0.9);
    const dailyAvgExpenseCurrent = dayOfMonth > 0 ? totalExpense / dayOfMonth : 0;
    const dailyAvgExpenseHist = histAvgExpense / daysInMonth;
    const predictedDailyRemainingExpense = (dailyAvgExpenseCurrent * currentWeight) + (dailyAvgExpenseHist * (1 - currentWeight));
    const predictedEndBalance = balance + Math.max(0, (histAvgIncome - totalIncome) * (1 - currentWeight)) - (predictedDailyRemainingExpense * daysLeft);
    const categoryTotals: Record<string, number> = {};
    monthlyTransactions.filter(t => t.type === 'chi').forEach(t => { categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount; });
    const topCategory = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1])[0];
    const last3DaysAvg = monthlyTransactions.filter(t => (today.getTime() - new Date(t.date).getTime()) / (1000 * 3600 * 24) <= 3 && t.type === 'chi').reduce((acc, t) => acc + t.amount, 0) / 3;
    return {
      predictedEndBalance: isNaN(predictedEndBalance) ? balance : predictedEndBalance,
      isUnusual: last3DaysAvg > dailyAvgExpenseCurrent * 1.4 && dailyAvgExpenseCurrent > 0,
      savingTip: topCategory && (totalBudget > 0 || totalExpense > 0) && topCategory[1] > (Math.max(totalBudget, totalExpense) * 0.3) 
        ? `Chi ti√™u cho ${topCategory[0]} ƒëang chi·∫øm t·ªâ tr·ªçng l·ªõn (${totalExpense > 0 ? Math.round((topCategory[1]/totalExpense)*100) : 0}% t·ªïng chi). H√£y c√¢n nh·∫Øc t·ªëi ∆∞u m·ª•c n√†y.`
        : predictedEndBalance < 0 ? "C·∫£nh b√°o: D·ª± b√°o s·ªë d∆∞ cu·ªëi th√°ng c√≥ th·ªÉ b·ªã √¢m. H√£y ki·ªÉm so√°t chi ti√™u ch·∫∑t ch·∫Ω h∆°n!" : "T√¨nh h√¨nh t√†i ch√≠nh c·ªßa b·∫°n ƒëang kh√° ·ªïn ƒë·ªãnh."
    };
  }, [transactions, monthlyTransactions, totalIncome, totalExpense, balance, totalBudget, currentMonth, currentYear]);

  const addTransaction = (t: Omit<Transaction, 'id'>) => { setTransactions([{ ...t, id: Math.random().toString(36).substr(2, 9) }, ...transactions]); setShowAddModal(false); };
  const deleteTransaction = (id: string) => { setTransactions(transactions.filter(t => t.id !== id)); };
  const updateBudget = (category: string, limit: number) => { const existing = budgets.find(b => b.category === category); if (existing) { setBudgets(budgets.map(b => b.category === category ? { ...b, limit } : b)); } else { setBudgets([...budgets, { category, limit }]); } };
  const resetData = () => { if (window.confirm('X√≥a h·∫øt d·ªØ li·ªáu?')) { setTransactions([]); setBudgets([]); localStorage.clear(); } };
  const formatCurrency = (amount: number) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);

  return (
    <div className={`min-h-screen transition-colors duration-300 ${isDarkMode ? 'bg-[#0F172A] text-slate-100' : 'bg-[#F8FAFC] text-slate-900'}`}>
      <nav className={`fixed bottom-0 left-0 right-0 z-50 md:top-0 md:bottom-0 md:left-0 md:w-20 lg:w-64 border-t md:border-t-0 md:border-r ${isDarkMode ? 'bg-[#1E293B] border-slate-800' : 'bg-white border-slate-200'} px-4 py-2 md:py-8 flex md:flex-col justify-between items-center`}>
        <div className="hidden md:flex items-center gap-3 mb-12 lg:px-4"><div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-500/20"><Wallet size={24} /></div><span className="hidden lg:block font-bold text-xl tracking-tight">Chau Money</span></div>
        <div className="flex md:flex-col gap-2 md:gap-4 w-full justify-around md:justify-start">
          <NavButton active={activeTab === 'dashboard'} onClick={() => setActiveTab('dashboard')} icon={<LayoutDashboard size={20} />} label="T·ªïng quan" />
          <NavButton active={activeTab === 'transactions'} onClick={() => setActiveTab('transactions')} icon={<ArrowUpCircle size={20} />} label="Giao d·ªãch" />
          <NavButton active={activeTab === 'reports'} onClick={() => setActiveTab('reports')} icon={<PieChartIcon size={20} />} label="B√°o c√°o" />
          <NavButton active={activeTab === 'settings'} onClick={() => setActiveTab('settings')} icon={<SettingsIcon size={20} />} label="C√†i ƒë·∫∑t" />
        </div>
        <div className="mt-auto w-full lg:px-4"><button onClick={() => setIsDarkMode(!isDarkMode)} className={`w-full p-3 rounded-xl flex items-center justify-center lg:justify-start gap-3 transition-colors ${isDarkMode ? 'hover:bg-slate-800 text-slate-400' : 'hover:bg-slate-100 text-slate-500'}`}>{isDarkMode ? <Sun size={20} /> : <Moon size={20} />}<span className="hidden lg:block text-sm font-medium">{isDarkMode ? 'Giao di·ªán s√°ng' : 'Giao di·ªán t·ªëi'}</span></button></div>
      </nav>

      <main className="pb-24 md:pb-8 md:pl-20 lg:pl-64 min-h-screen">
        <header className="px-6 py-8 md:px-10 flex justify-between items-center">
          <div><h1 className="text-2xl md:text-3xl font-bold tracking-tight">{activeTab === 'dashboard' ? 'Ch√†o Chau, üëã' : activeTab === 'transactions' ? 'L·ªãch s·ª≠' : activeTab === 'reports' ? 'B√°o c√°o' : 'C√†i ƒë·∫∑t'}</h1><p className={`text-sm mt-1 ${isDarkMode ? 'text-slate-400' : 'text-slate-500'}`}>{new Date().toLocaleDateString('vi-VN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p></div>
          <button onClick={() => setShowAddModal(true)} className="bg-indigo-600 hover:bg-indigo-700 text-white p-3 md:px-6 md:py-3 rounded-2xl flex items-center gap-2 shadow-lg shadow-indigo-500/30 transition-all active:scale-95"><Plus size={20} /><span className="hidden md:block font-semibold">Th√™m giao d·ªãch</span></button>
        </header>

        <div className="px-6 md:px-10 max-w-7xl mx-auto">
          {activeTab === 'dashboard' && (
            <div className="space-y-8">
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <StatCard title="S·ªë d∆∞" value={formatCurrency(balance)} icon={<Wallet className="text-indigo-500" />} isDarkMode={isDarkMode} trend={aiInsights.predictedEndBalance > balance ? 'up' : 'down'} trendText={`D·ª± ki·∫øn: ${formatCurrency(aiInsights.predictedEndBalance)}`} />
                <StatCard title="Thu nh·∫≠p" value={formatCurrency(totalIncome)} icon={<ArrowUpCircle className="text-emerald-500" />} isDarkMode={isDarkMode} />
                <StatCard title="Chi ti√™u" value={formatCurrency(totalExpense)} icon={<ArrowDownCircle className="text-rose-500" />} isDarkMode={isDarkMode} />
              </div>
              <div className={`p-6 rounded-3xl border ${isDarkMode ? 'bg-[#1E293B] border-slate-800' : 'bg-white border-slate-100 shadow-sm'}`}>
                <div className="flex justify-between items-end mb-4"><div><h3 className="font-bold text-lg">Ng√¢n s√°ch</h3><p className={`text-sm ${isDarkMode ? 'text-slate-400' : 'text-slate-500'}`}>{formatCurrency(totalExpense)} / {formatCurrency(totalBudget)}</p></div><span className={`text-2xl font-bold ${budgetProgress > 90 ? 'text-rose-500' : 'text-indigo-500'}`}>{Math.round(budgetProgress)}%</span></div>
                <div className={`h-3 w-full rounded-full overflow-hidden ${isDarkMode ? 'bg-slate-800' : 'bg-slate-100'}`}><motion.div initial={{ width: 0 }} animate={{ width: `${Math.min(budgetProgress, 100)}%` }} className={`h-full rounded-full ${budgetProgress > 90 ? 'bg-rose-500' : 'bg-indigo-500'}`} /></div>
              </div>
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div className="space-y-4"><div className="flex justify-between items-center"><h3 className="font-bold text-xl">G·∫ßn ƒë√¢y</h3><button onClick={() => setActiveTab('transactions')} className="text-indigo-500 text-sm font-semibold flex items-center gap-1">Xem t·∫•t c·∫£ <ChevronRight size={16} /></button></div><div className="space-y-3">{transactions.slice(0, 5).map(t => <TransactionItem key={t.id} transaction={t} isDarkMode={isDarkMode} onDelete={deleteTransaction} />)}</div></div>
                <div className="space-y-4"><h3 className="font-bold text-xl">Ph√¢n t√≠ch</h3><div className="space-y-4"><InsightCard icon={<TrendingUp className="text-indigo-500" />} title="D·ª± b√°o" content={`D·ª± ki·∫øn s·ªë d∆∞ cu·ªëi th√°ng: ${formatCurrency(aiInsights.predictedEndBalance)}`} isDarkMode={isDarkMode} /><InsightCard icon={<Lightbulb className="text-amber-500" />} title="G·ª£i √Ω" content={aiInsights.savingTip} isDarkMode={isDarkMode} />{aiInsights.isUnusual && <InsightCard icon={<AlertCircle className="text-rose-500" />} title="C·∫£nh b√°o" content="Chi ti√™u 3 ng√†y qua tƒÉng ƒë·ªôt bi·∫øn!" isDarkMode={isDarkMode} variant="warning" />}</div></div>
              </div>
            </div>
          )}
          {/* ... C√°c tab kh√°c t∆∞∆°ng t·ª± ... */}
        </div>
      </main>
      {/* Modal Add Transaction ... */}
    </div>
  );
}

function NavButton({ active, onClick, icon, label }: { active: boolean, onClick: () => void, icon: React.ReactNode, label: string }) { return <button onClick={onClick} className={`relative p-3 md:p-4 rounded-2xl flex items-center gap-3 transition-all group ${active ? 'text-indigo-600 md:bg-indigo-50 dark:md:bg-indigo-900/20' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-200'}`}>{icon}<span className={`hidden lg:block text-sm font-bold ${active ? 'text-indigo-600' : ''}`}>{label}</span>{active && <motion.div layoutId="nav-active" className="absolute bottom-0 left-1/2 -translate-x-1/2 md:left-0 md:translate-x-0 md:top-1/2 md:-translate-y-1/2 w-1 h-1 md:w-1 md:h-8 bg-indigo-600 rounded-full" />}</button>; }
function StatCard({ title, value, icon, isDarkMode, trend, trendText }: { title: string, value: string, icon: React.ReactNode, isDarkMode: boolean, trend?: 'up' | 'down', trendText?: string }) { return <div className={`p-6 rounded-[2rem] border transition-all hover:shadow-xl hover:-translate-y-1 ${isDarkMode ? 'bg-[#1E293B] border-slate-800' : 'bg-white border-slate-100 shadow-sm'}`}><div className="flex justify-between items-start mb-4"><div className={`p-3 rounded-2xl ${isDarkMode ? 'bg-slate-800' : 'bg-slate-50'}`}>{icon}</div>{trend && <div className={`flex items-center gap-1 text-xs font-bold px-2 py-1 rounded-full ${trend === 'up' ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600'}`}>{trend === 'up' ? <ArrowUpCircle size={12} /> : <ArrowDownCircle size={12} />}{trend === 'up' ? '+12%' : '-5%'}</div>}</div><p className={`text-sm font-medium ${isDarkMode ? 'text-slate-400' : 'text-slate-500'}`}>{title}</p><h4 className="text-2xl font-bold mt-1 tracking-tight">{value}</h4>{trendText && <p className="text-[10px] mt-2 opacity-60 font-medium uppercase tracking-wider">{trendText}</p>}</div>; }
const TransactionItem: React.FC<{ transaction: Transaction, isDarkMode: boolean, onDelete: (id: string) => void }> = ({ transaction, isDarkMode, onDelete }) => <motion.div layout initial={{ opacity: 0, x: -10 }} animate={{ opacity: 1, x: 0 }} className={`group p-4 rounded-2xl border flex items-center justify-between transition-all ${isDarkMode ? 'bg-[#1E293B] border-slate-800 hover:bg-slate-800' : 'bg-white border-slate-100 hover:shadow-md'}`}><div className="flex items-center gap-4"><div className={`w-12 h-12 rounded-xl flex items-center justify-center ${transaction.type === 'thu' ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600'}`}>{transaction.type === 'thu' ? <Plus size={20} /> : <Minus size={20} />}</div><div><p className="font-bold">{transaction.category}</p><p className={`text-xs ${isDarkMode ? 'text-slate-400' : 'text-slate-500'}`}>{transaction.note || 'Kh√¥ng c√≥ ghi ch√∫'} ‚Ä¢ {new Date(transaction.date).toLocaleDateString('vi-VN')}</p></div></div><div className="flex items-center gap-4"><p className={`font-bold text-lg ${transaction.type === 'thu' ? 'text-emerald-500' : 'text-rose-500'}`}>{transaction.type === 'thu' ? '+' : '-'}{new Intl.NumberFormat('vi-VN').format(transaction.amount)}</p><button onClick={() => onDelete(transaction.id)} className="opacity-0 group-hover:opacity-100 p-2 text-slate-400 hover:text-rose-500 transition-all"><Trash2 size={18} /></button></div></motion.div>;
function InsightCard({ icon, title, content, isDarkMode, variant = 'default' }: { icon: React.ReactNode, title: string, content: string, isDarkMode: boolean, variant?: 'default' | 'warning' }) { return <div className={`p-5 rounded-3xl border flex gap-4 transition-all ${variant === 'warning' ? 'bg-rose-50/50 border-rose-100' : isDarkMode ? 'bg-[#1E293B] border-slate-800' : 'bg-white border-slate-100 shadow-sm'}`}><div className={`mt-1 p-2 rounded-xl h-fit ${isDarkMode ? 'bg-slate-800' : 'bg-slate-50'}`}>{icon}</div><div><h5 className="font-bold text-sm">{title}</h5><p className={`text-sm mt-1 leading-relaxed ${isDarkMode ? 'text-slate-400' : 'text-slate-600'}`}>{content}</p></div></div>; }